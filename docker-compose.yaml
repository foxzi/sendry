services:
  sendry:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        TARGET: sendry
        VERSION: ${VERSION:-dev}
        COMMIT: ${COMMIT:-unknown}
        BUILD_TIME: ${BUILD_TIME:-unknown}
    image: sendry:${VERSION:-latest}
    container_name: sendry
    restart: unless-stopped
    ports:
      - "25:25"
      - "465:465"
      - "587:587"
      - "8080:8080"
      - "9090:9090"
    volumes:
      - sendry-data:/var/lib/sendry
      - ./configs/sendry.example.yaml:/etc/sendry/config.yaml:ro
    environment:
      - TZ=${TZ:-UTC}
    command: ["sendry", "serve", "--config", "/etc/sendry/config.yaml"]
    healthcheck:
      test: ["CMD", "/usr/bin/sendry", "version"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    networks:
      - sendry-net

  sendry-web:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        TARGET: sendry-web
        VERSION: ${VERSION:-dev}
        COMMIT: ${COMMIT:-unknown}
        BUILD_TIME: ${BUILD_TIME:-unknown}
    image: sendry-web:${VERSION:-latest}
    container_name: sendry-web
    restart: unless-stopped
    ports:
      - "8088:8088"
    volumes:
      - sendry-web-data:/var/lib/sendry-web
      - ./configs/web.example.yaml:/etc/sendry/web.yaml:ro
    environment:
      - TZ=${TZ:-UTC}
    command: ["sendry-web", "serve", "--config", "/etc/sendry/web.yaml"]
    healthcheck:
      test: ["CMD", "/usr/bin/sendry-web", "version"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - sendry-net
    depends_on:
      - sendry

volumes:
  sendry-data:
    driver: local
  sendry-web-data:
    driver: local

networks:
  sendry-net:
    driver: bridge
