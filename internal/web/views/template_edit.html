{{define "content"}}
<link href="https://unpkg.com/grapesjs/dist/css/grapes.min.css" rel="stylesheet">
<link href="https://unpkg.com/grapesjs-preset-newsletter/dist/grapesjs-preset-newsletter.css" rel="stylesheet">
<style>
.editor-container {
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
    margin-bottom: 1rem;
}
.gjs-one-bg { background-color: var(--bg-card); }
.gjs-two-color { color: var(--text); }
.gjs-three-bg { background-color: var(--bg); }
.gjs-four-color, .gjs-four-color-h:hover { color: var(--primary); }
#gjs-editor { min-height: 500px; }
.editor-tabs {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
}
.editor-tab {
    padding: 0.5rem 1rem;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    background: var(--bg-card);
    cursor: pointer;
    font-size: 0.875rem;
}
.editor-tab.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}
.code-editor { display: none; }
.code-editor.active { display: block; }
.visual-editor { display: none; }
.visual-editor.active { display: block; }
</style>

<div class="page-header">
    <h1>Edit: {{.Template.Name}}</h1>
</div>

<form method="post" action="/templates/{{.Template.ID}}" class="card" id="template-form">
    <input type="hidden" name="_method" value="PUT">
    <div class="card-body">
        <div class="form-row">
            <div class="form-group">
                <label for="name">Name *</label>
                <input type="text" id="name" name="name" required class="input" value="{{.Template.Name}}">
            </div>
            <div class="form-group">
                <label for="folder">Folder</label>
                <input type="text" id="folder" name="folder" class="input" value="{{.Template.Folder}}" list="folders">
                <datalist id="folders">
                    {{range .Folders}}
                    <option value="{{.}}">
                    {{end}}
                </datalist>
            </div>
        </div>

        <div class="form-group">
            <label for="description">Description</label>
            <textarea id="description" name="description" class="input" rows="2">{{.Template.Description}}</textarea>
        </div>

        <div class="form-group">
            <label for="subject">Subject *</label>
            <input type="text" id="subject" name="subject" required class="input" value="{{.Template.Subject}}">
            <small class="form-help">Use {{"{{"}}variable{{"}}"}} syntax for dynamic content</small>
        </div>

        <div class="form-group">
            <label>HTML Content</label>
            <div class="editor-tabs">
                <button type="button" class="editor-tab active" data-editor="visual">Visual Editor</button>
                <button type="button" class="editor-tab" data-editor="code">Code Editor</button>
            </div>

            <div class="visual-editor active">
                <div class="editor-container">
                    <div id="gjs-editor"></div>
                </div>
            </div>

            <div class="code-editor">
                <textarea id="html-code" class="input code" rows="15">{{.Template.HTML}}</textarea>
            </div>

            <input type="hidden" name="html" id="html-hidden">
        </div>

        <div class="form-group">
            <label for="text">Plain Text Content</label>
            <textarea id="text" name="text" class="input code" rows="8">{{.Template.Text}}</textarea>
        </div>

        <div class="form-group">
            <label for="variables">Variables (JSON)</label>
            <textarea id="variables" name="variables" class="input code" rows="4">{{.Template.Variables}}</textarea>
            <small class="form-help">Define expected variables and their types</small>
        </div>

        <div class="form-group">
            <label for="change_note">Change Note</label>
            <input type="text" id="change_note" name="change_note" class="input" placeholder="Describe what changed...">
            <small class="form-help">This will be recorded in version history</small>
        </div>
    </div>

    <div class="card-footer">
        <a href="/templates/{{.Template.ID}}" class="btn btn-secondary">Cancel</a>
        <button type="submit" class="btn btn-primary">Save Changes</button>
    </div>
</form>

<script src="https://unpkg.com/grapesjs"></script>
<script src="https://unpkg.com/grapesjs-preset-newsletter"></script>
<script>
(function() {
    const initialHtml = document.getElementById('html-code').value || '<body></body>';

    const editor = grapesjs.init({
        container: '#gjs-editor',
        plugins: ['grapesjs-preset-newsletter'],
        pluginsOpts: {
            'grapesjs-preset-newsletter': {}
        },
        height: '500px',
        storageManager: false,
        assetManager: {
            embedAsBase64: true
        }
    });

    // Load initial content
    editor.setComponents(initialHtml);

    // Tab switching
    const tabs = document.querySelectorAll('.editor-tab');
    const visualEditor = document.querySelector('.visual-editor');
    const codeEditor = document.querySelector('.code-editor');
    const htmlCode = document.getElementById('html-code');

    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            tabs.forEach(t => t.classList.remove('active'));
            this.classList.add('active');

            if (this.dataset.editor === 'visual') {
                visualEditor.classList.add('active');
                codeEditor.classList.remove('active');
                // Load code into visual editor
                editor.setComponents(htmlCode.value);
            } else {
                visualEditor.classList.remove('active');
                codeEditor.classList.add('active');
                // Export visual editor to code
                htmlCode.value = editor.getHtml() + '<style>' + editor.getCss() + '</style>';
            }
        });
    });

    // Form submission
    document.getElementById('template-form').addEventListener('submit', function(e) {
        const htmlHidden = document.getElementById('html-hidden');

        if (visualEditor.classList.contains('active')) {
            // Get HTML from visual editor
            htmlHidden.value = editor.getHtml() + '<style>' + editor.getCss() + '</style>';
        } else {
            // Get HTML from code editor
            htmlHidden.value = htmlCode.value;
        }
    });
})();
</script>
{{end}}
