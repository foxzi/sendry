# Техническое задание: Sendry Web

## 1. Общие сведения

**Sendry Web** — веб-интерфейс для управления шаблонами, рассылками и мониторингом Sendry с поддержкой нескольких серверов.

### 1.1. Назначение

- Создание и управление email шаблонами
- Запуск и контроль рассылок
- Мониторинг очередей, доставки и состояния серверов
- Единая панель для нескольких Sendry серверов
- Совместимость с Sendry как с базовой системой отправки

### 1.2. Поставка

- Отдельный бинарник `sendry-web` в составе пакетов sendry
- Отдельный systemd сервис `sendry-web.service`
- Собственный порт (по умолчанию 8088)
- Собственная конфигурация `/etc/sendry/web.yaml`
- Собственная БД SQLite

### 1.3. Технические требования

- Backend: Go (Golang)
- Frontend: HTML + CSS + JS с использованием HTMX
- SSR-first подход, минимум клиентской логики
- REST интеграция с Sendry API через HTTP
- БД: SQLite

---

## 2. Архитектура и мультисерверность

### 2.1. Модель подключения серверов

- Пользователь может подключить несколько серверов Sendry
- Каждый сервер хранится как запись в конфигурации
- Для каждого сервера указываются:
  - Название
  - Base URL (например, https://mta-1.example.com)
  - API ключ
  - Метки окружения (prod/stage/dev)
  - Статус доступности

### 2.2. Контекст работы

- Глобальный селектор сервера или группы серверов
- Все разделы панели должны работать в контексте выбранного сервера
- Для операций рассылки возможен режим "multi-send" на несколько серверов:
  - Разделение нагрузки по доменам или по заданным правилам
  - Детальный отчет о выполнении по каждому серверу

---

## 3. Доступы

- Единая роль для всех пользователей
- Все пользователи имеют одинаковые права в панели
- Доступ в приложение через Authentik ограничивается членством в группе
- Авторизация: встроенная (локальные пользователи) или OpenID Connect через Authentik (опционально)

---

## 4. Шаблоны писем

### 4.1. Управление шаблонами

- Список шаблонов с фильтрами (имя, домен, теги, дата)
- Создание шаблонов с HTML и text версиями
- Версионирование шаблонов
- Теги и папки для группировки
- Импорт/экспорт шаблонов

### 4.2. Редактор

- HTML редактор с превью
- Режим split view (код + предпросмотр)
- Проверка переменных
- Поддержка common partials (header/footer)
- Проверка и тестирование шаблона на тестовых данных

### 4.3. Интеграция с Sendry API

- CRUD через /api/v1/templates
- Preview через /api/v1/templates/{id}/preview
- Отправка тестового письма через /api/v1/send/template

---

## 5. Рассылки

### 5.1. Основные сущности

- Кампания (Campaign)
- Список получателей (Recipient list)
- Рассылка (Send job)

### 5.2. Возможности

- Создание рассылки из шаблона
- Загрузка списка получателей (CSV, JSON)
- Планирование отправки (schedule)
- Segmenting по доменам и tags
- Режимы:
  - Single server send
  - Multi server send
  - Sandbox/redirect/bcc режимы (через Sendry домены)

### 5.3. Статусы рассылки

- Draft
- Scheduled
- Running
- Paused
- Completed
- Failed

### 5.4. Контроль отправки

- Пауза и возобновление
- Отмена
- Повторная отправка failed
- Изменение rate limits per job (если поддержано API)

---

## 6. Мониторинг и аналитика

### 6.1. Общий мониторинг

- Сводка по всем серверам:
  - Статус доступности
  - Очередь (size, oldest)
  - Уровень ошибок
  - Доставка (success/fail)
- Фильтры по серверу/домену/времени

### 6.2. Очередь

- Просмотр очереди по серверу
- Поиск по message_id
- Retry/удаление сообщений (если разрешено)

### 6.3. Tracking

- Статистика открытий/кликов (если включено)
- CTR по кампаниям
- Экспорт данных (CSV)

---

## 7. Настройки доменов

- Список доменов на сервере
- Просмотр текущих лимитов и режима домена
- Управление DKIM (показать, сгенерировать, проверить)
- TLS сертификаты (просмотр, статус)

---

## 8. Логи и аудит

- Просмотр логов API запросов панели
- Audit log действий пользователей (кто что сделал)
- Фильтры по времени и пользователю

---

## 9. Требования к UI/UX

- Быстрая навигация между серверами
- Явное отображение выбранного сервера и окружения
- Информативные статусы и алерты
- Поддержка мобильных устройств (адаптив)
- Темы: светлая и тёмная
- Пагинация, поиск, сортировка в таблицах
- Явные пустые состояния и ошибки
- Временные зоны в UI конфигурируемы
- Локализация (минимум RU и EN)

---

## 10. Требования к безопасности

- Авторизация через JWT/Session
- CSRF защита
- Обязательное HTTPS
- OIDC (Authentik) настраивается через конфигурацию:
  - client_id
  - client_secret
  - issuer_url
  - redirect_url
  - scopes (по умолчанию: openid, profile, email)
  - allowed_groups (доступ только для указанных групп)
- Fallback: при недоступности OIDC возможен вход локальными учетками (если включены)
- Если allowed_groups пустой, доступ есть у всех аутентифицированных пользователей
- Политика паролей для локальных учеток (минимум 10 символов)
- TTL сессий настраиваемый
- Шифрование API ключей Sendry в хранилище

---

## 11. Конфигурация

Файл конфигурации `/etc/sendry/web.yaml`:

```yaml
server:
  listen_addr: ":8088"
  # TLS (опционально)
  tls:
    enabled: false
    cert_file: ""
    key_file: ""

database:
  path: "/var/lib/sendry-web/app.db"

auth:
  local_enabled: true
  session_secret: "change-me-secret-key"
  session_ttl: 24h

  oidc:
    enabled: false
    provider: authentik
    client_id: "sendry-web"
    client_secret: "secret"
    issuer_url: "https://auth.example.com/application/o/sendry-web/"
    redirect_url: "https://panel.example.com/auth/callback"
    scopes:
      - openid
      - profile
      - email
    allowed_groups:
      - "sendry-web-users"

# Подключение к серверам Sendry
sendry:
  servers:
    - name: "mta-1"
      base_url: "https://mta-1.example.com"
      api_key: "token-1"
      env: "prod"
    - name: "mta-2"
      base_url: "https://mta-2.example.com"
      api_key: "token-2"
      env: "stage"

  # Стратегия multi-send
  multi_send:
    strategy: weighted_round_robin  # round_robin, weighted_round_robin, domain_affinity
    weights:
      mta-1: 3
      mta-2: 1
    domain_affinity:
      "example.com": "mta-1"
      "example.org": "mta-2"
    failover:
      enabled: true
      max_retries: 2

logging:
  level: info
  format: json
```

---

## 12. Хранение данных (SQLite)

### 12.1. Таблицы

- `users` - локальные учетные записи
- `sessions` - сессии пользователей
- `campaigns` - кампании рассылок
- `recipient_lists` - списки получателей
- `send_jobs` - рассылки и их статусы
- `send_job_items` - элементы рассылки (состояние доставки)
- `audit_log` - журнал действий пользователей
- `settings` - настройки панели

### 12.2. Retention

- Настраиваемый retention для send_job_items и audit_log
- Автоматическая очистка старых записей
- Миграции схемы при старте

---

## 13. Нефункциональные требования

- Время отклика UI: до 300 мс для типичных операций, до 2 с для тяжелых (поиск, импорт)
- Пагинация в списках по умолчанию, лимит на страницу настраиваемый
- Таймауты запросов к Sendry API: 3-10 с с ретраями по 5xx/timeout
- Кэширование неизменяемых данных (шаблоны, домены) до 60 с
- Горизонтальное масштабирование без sticky sessions

---

## 14. Совместимость с Sendry API

- Поддержка API v1
- Если API не поддерживает функцию, UI показывает "не поддерживается"
- Требуемые эндпоинты:
  - /api/v1/templates
  - /api/v1/send/template
  - /api/v1/queue
  - /api/v1/status/{id}
  - /api/v1/domains
  - /api/v1/ratelimits
  - /health

---

## 15. Импорт и экспорт

- Импорт получателей из CSV и JSON
- Валидация email, дедупликация, проверка обязательных полей
- Лимит размера файла задается в конфигурации
- Экспорт результатов рассылки в CSV

---

## 16. Отправка и контроль

- Throttling по серверу и по домену
- Dry-run для тестовой выборки (N получателей)
- Дедупликация адресов внутри рассылки
- Хранение статуса отправки по каждому получателю

---

## 17. Стратегия multi-send

### 17.1. Цели

- Балансировка нагрузки между серверами
- Учет доменных политик и лимитов
- Предсказуемость и повторяемость результатов

### 17.2. Входные данные

- Список серверов Sendry и их статусы
- Домен отправителя и домены получателей
- Лимиты сервера/домена (если доступны через API)
- Приоритеты серверов (опционально)

### 17.3. Алгоритм распределения

1. Отфильтровать недоступные сервера
2. Для каждого домена получателей применить правило привязки:
   - Если задано правило `domain -> server`, использовать его
   - Иначе применить round-robin с учетом веса сервера
3. Учитывать лимиты: если сервер превышает лимит, переместить часть на следующий
4. Фиксировать выбор сервера в send_job_items для воспроизводимости

### 17.4. Политики распределения

- **Round-robin** по серверам
- **Weighted round-robin** с весами из конфигурации
- **Domain-affinity**: домен получателя закреплен за сервером
- **Failover**: при ошибках отправка переходит на резервный сервер

### 17.5. Отчетность

- Для каждой рассылки хранить статистику по серверу
- Отображать долю отправки и ошибки по каждому серверу
- История решений (какой сервер выбран и почему)

---

## 18. Мониторинг и алерты

- Индикация недоступности серверов
- Пороговые алерты по росту очереди и ошибкам доставки
- Настраиваемые интервалы опроса Sendry API
- Уведомления по email или webhook (опционально)

---

## 19. Сборка и пакетирование

### 19.1. Бинарники

- `sendry` - основной MTA сервер
- `sendry-web` - веб-интерфейс

### 19.2. Systemd сервисы

- `sendry.service` - MTA сервер
- `sendry-web.service` - веб-интерфейс

### 19.3. Пакеты

В составе DEB/RPM/APK пакетов sendry:
- Оба бинарника
- Оба systemd сервиса
- Примеры конфигураций
- Документация

### 19.4. Docker

Два образа или один образ с разными entrypoint:
- `sendry serve` - MTA
- `sendry-web serve` - веб-интерфейс

---

## 20. CLI команды

```bash
# Запуск
sendry-web serve -c /etc/sendry/web.yaml

# Управление пользователями
sendry-web user create --email admin@example.com --password secret
sendry-web user list
sendry-web user delete admin@example.com
sendry-web user reset-password admin@example.com

# Миграции и обслуживание
sendry-web migrate          # Применить миграции БД
sendry-web cleanup          # Очистить старые данные

# Проверка конфигурации
sendry-web config validate -c /etc/sendry/web.yaml
```

---

## 21. TODO

- [ ] Уточнить формат хранения шаблонов и версии
- [ ] Определить модель данных для кампаний
- [ ] Подготовить макеты UI
- [ ] Определить структуру роутов веб-интерфейса
