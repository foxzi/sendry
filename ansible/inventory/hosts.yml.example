all:
  children:
    # Single server deployment
    sendry_single:
      hosts:
        mail.example.com:
          ansible_host: 192.168.1.10
          sendry_hostname: mail.example.com
          sendry_api_key: "change-this-api-key"
          sendry_smtp_auth_users:
            admin: "change-this-password"
          sendry_domains:
            example.com:
              dkim_enabled: true
              dkim_selector: mail
              rate_limit:
                messages_per_hour: 1000
                messages_per_day: 10000

    # Multi-server deployment with shared DKIM keys
    sendry_cluster:
      hosts:
        mail1.example.com:
          ansible_host: 192.168.1.20
          sendry_hostname: mail1.example.com
        mail2.example.com:
          ansible_host: 192.168.1.21
          sendry_hostname: mail2.example.com
        mail3.example.com:
          ansible_host: 192.168.1.22
          sendry_hostname: mail3.example.com

      vars:
        ansible_user: root
        sendry_install_method: package
        sendry_version: latest

        sendry_api_key: "shared-api-key-for-cluster"
        sendry_smtp_auth_users:
          admin: "shared-admin-password"
          api: "shared-api-password"

        sendry_domains:
          example.com:
            dkim_enabled: true
            dkim_selector: mail
            mode: production
            rate_limit:
              messages_per_hour: 5000
              messages_per_day: 50000

        # DKIM keys management:
        # Option 1: Use the DKIM playbook (recommended):
        #   ansible-playbook playbooks/dkim.yml -e dkim_action=generate -e dkim_domain=example.com
        #   ansible-playbook playbooks/dkim.yml -e dkim_action=deploy
        #
        # Option 2: Provide keys manually in sendry_dkim_keys (store in Ansible Vault):
        # sendry_dkim_keys:
        #   example.com:
        #     private: |
        #       -----BEGIN PRIVATE KEY-----
        #       ...
        #       -----END PRIVATE KEY-----
        #     public: |
        #       -----BEGIN PUBLIC KEY-----
        #       ...
        #       -----END PUBLIC KEY-----
        sendry_dkim_keys: {}

    # Web panel + MTA cluster deployment
    # Panel connects to multiple MTA servers via API
    sendry_mta_cluster:
      hosts:
        mta-1.example.com:
          ansible_host: 192.168.1.30
          sendry_hostname: mta-1.example.com
        mta-2.example.com:
          ansible_host: 192.168.1.31
          sendry_hostname: mta-2.example.com

      vars:
        sendry_mta_enabled: true
        sendry_web_enabled: false

        sendry_api_key: "mta-cluster-api-key"
        sendry_smtp_auth_users:
          admin: "smtp-admin-password"
          api: "smtp-api-password"

        sendry_domains:
          example.com:
            dkim_enabled: true
            dkim_selector: mail
            mode: production

        # Use DKIM playbook to generate and deploy shared keys:
        #   ansible-playbook playbooks/dkim.yml -e dkim_action=generate -e dkim_domain=example.com
        #   ansible-playbook playbooks/dkim.yml -e dkim_action=deploy -l sendry_mta_cluster
        sendry_dkim_keys: {}

    # Web panel (separate server, connects to MTA cluster)
    sendry_panel:
      hosts:
        panel.example.com:
          ansible_host: 192.168.1.40

      vars:
        sendry_mta_enabled: false
        sendry_web_enabled: true

        sendry_web_session_secret: "change-this-secret-at-least-32-characters"

        # Connect to MTA servers
        sendry_web_servers:
          - name: "mta-1"
            base_url: "http://192.168.1.30:8080"
            api_key: "mta-cluster-api-key"
            env: "prod"
          - name: "mta-2"
            base_url: "http://192.168.1.31:8080"
            api_key: "mta-cluster-api-key"
            env: "prod"

        # Load balancing strategy
        sendry_web_multi_send_strategy: round_robin
        sendry_web_multi_send_failover_enabled: true
        sendry_web_multi_send_failover_max_retries: 2

        # Optional: weighted balancing
        # sendry_web_multi_send_strategy: weighted_round_robin
        # sendry_web_multi_send_weights:
        #   mta-1: 3
        #   mta-2: 1

        # Optional: domain affinity (specific domains to specific servers)
        # sendry_web_multi_send_strategy: domain_affinity
        # sendry_web_multi_send_domain_affinity:
        #   "example.com": "mta-1"
        #   "example.org": "mta-2"

        # Caddy for HTTPS
        sendry_caddy_enabled: true
        sendry_caddy_domain: panel.example.com
        sendry_caddy_email: admin@example.com

        # Optional: OIDC authentication
        # sendry_web_oidc_enabled: true
        # sendry_web_oidc_provider: authentik
        # sendry_web_oidc_client_id: "sendry-web"
        # sendry_web_oidc_client_secret: "{{ vault_oidc_secret }}"
        # sendry_web_oidc_issuer_url: "https://auth.example.com/application/o/sendry/"
        # sendry_web_oidc_redirect_url: "https://panel.example.com/auth/callback"

  vars:
    ansible_user: root
    # ansible_ssh_private_key_file: ~/.ssh/id_rsa

# Deployment order for panel + MTA cluster:
#   1. Deploy MTA servers first:
#      ansible-playbook -i inventory/hosts.yml playbooks/sendry.yml -l sendry_mta_cluster
#
#   2. Generate and deploy shared DKIM keys:
#      ansible-playbook playbooks/dkim.yml -e dkim_action=generate -e dkim_domain=example.com
#      ansible-playbook playbooks/dkim.yml -e dkim_action=deploy -l sendry_mta_cluster
#
#   3. Deploy web panel:
#      ansible-playbook -i inventory/hosts.yml playbooks/sendry.yml -l sendry_panel
