---
# Validate MTA variables (only when MTA is enabled)
- name: Validate MTA required variables
  ansible.builtin.assert:
    that:
      - sendry_api_key | length > 0
      - sendry_smtp_auth_users | length > 0
    fail_msg: "Required variables sendry_api_key and sendry_smtp_auth_users must be set"
  when: sendry_mta_enabled | bool
  tags: [always]

- name: Validate web variables
  ansible.builtin.assert:
    that:
      - sendry_web_session_secret | length >= 32
      - sendry_web_servers | length > 0 or sendry_mta_enabled | bool
    fail_msg: "sendry_web_session_secret must be at least 32 characters and sendry_web_servers must be set when MTA is disabled"
  when: sendry_web_enabled | bool
  tags: [always]

- name: Validate caddy variables
  ansible.builtin.assert:
    that:
      - sendry_caddy_domain | length > 0
    fail_msg: "sendry_caddy_domain must be set when caddy is enabled"
  when: sendry_caddy_enabled | bool
  tags: [always]

# MTA installation and configuration
- name: Include installation tasks
  ansible.builtin.include_tasks: install.yml
  when: sendry_mta_enabled | bool
  tags: [install, mta]

- name: Include DKIM tasks
  ansible.builtin.include_tasks: dkim.yml
  when: sendry_mta_enabled | bool
  tags: [dkim, mta]

- name: Include configuration tasks
  ansible.builtin.include_tasks: configure.yml
  when: sendry_mta_enabled | bool
  tags: [configure, mta]

- name: Include firewall tasks
  ansible.builtin.include_tasks: firewall.yml
  when: sendry_configure_firewall | bool
  tags: [firewall]

# Sendry Web Panel
- name: Include web installation tasks
  ansible.builtin.include_tasks: install-web.yml
  when: sendry_web_enabled | bool
  tags: [install, web]

- name: Include web configuration tasks
  ansible.builtin.include_tasks: configure-web.yml
  when: sendry_web_enabled | bool
  tags: [configure, web]

# Caddy reverse proxy
- name: Include Caddy tasks
  ansible.builtin.include_tasks: caddy.yml
  when: sendry_caddy_enabled | bool
  tags: [caddy, web]
