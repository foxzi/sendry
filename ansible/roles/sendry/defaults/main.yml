---
# Enable MTA installation (set to false for web-only deployment)
sendry_mta_enabled: true

# Sendry installation method: 'binary' or 'package'
sendry_install_method: binary

# Binary installation settings
sendry_version: latest
sendry_binary_url: ""  # If empty, will be constructed from version
sendry_binary_checksum: ""  # Optional SHA256 checksum

# Package installation settings (for DEB/RPM)
sendry_package_path: ""  # Local path to package file

# Server settings
sendry_hostname: "{{ inventory_hostname }}"
sendry_user: sendry
sendry_group: sendry

# Directory paths
sendry_config_dir: /etc/sendry
sendry_data_dir: /var/lib/sendry
sendry_log_dir: /var/log/sendry
sendry_dkim_dir: "{{ sendry_data_dir }}/dkim"

# SMTP settings
sendry_smtp_listen: ":25"
sendry_smtp_submission: ":587"
sendry_smtp_smtps: ":465"
sendry_smtp_domain: "{{ sendry_hostname }}"
sendry_smtp_max_message_bytes: 10485760
sendry_smtp_max_recipients: 100
sendry_smtp_read_timeout: 60s
sendry_smtp_write_timeout: 60s

# IP addresses/CIDRs allowed to connect to SMTP (empty = allow all)
sendry_smtp_allowed_ips: []
# Example:
#   - "10.0.0.0/8"
#   - "192.168.1.0/24"
#   - "203.0.113.50"

# SMTP Authentication
sendry_smtp_auth_required: true
sendry_smtp_auth_users: {}
#  admin: "secure_password"
#  api: "api_password"

# Brute force protection
sendry_smtp_auth_max_failures: 5
sendry_smtp_auth_block_duration: 15m
sendry_smtp_auth_failure_window: 5m

# TLS settings
sendry_tls_cert_file: ""
sendry_tls_key_file: ""

# ACME (Let's Encrypt) settings
sendry_acme_enabled: false
sendry_acme_email: ""
sendry_acme_domains: []
sendry_acme_cache_dir: "{{ sendry_data_dir }}/certs"
# On-demand mode: port 80 is not opened automatically
# Use 'sendry tls renew' to obtain/renew certificates manually or via cron
sendry_acme_on_demand: true

# Domain configuration
sendry_domains: {}
# Example:
#   example.com:
#     dkim_enabled: true
#     dkim_selector: mail
#     mode: production  # production, sandbox, redirect, bcc
#     rate_limit:
#       messages_per_hour: 1000
#       messages_per_day: 10000
#       recipients_per_message: 100
#     redirect_to: []
#     bcc_to: []

# DKIM settings
# If sendry_dkim_keys is defined, these keys will be deployed to all servers
# Otherwise keys will be generated locally on each server
sendry_dkim_generate: true
sendry_dkim_key_bits: 2048

# Shared DKIM keys for multi-server deployment
# Store private keys in Ansible Vault for security
# Example:
#   sendry_dkim_keys:
#     example.com:
#       private: |
#         -----BEGIN PRIVATE KEY-----
#         ...
#         -----END PRIVATE KEY-----
#       public: |
#         -----BEGIN PUBLIC KEY-----
#         ...
#         -----END PUBLIC KEY-----
sendry_dkim_keys: {}

# Rate limiting
sendry_rate_limit_enabled: true
sendry_rate_limit_global:
  messages_per_hour: 50000
  messages_per_day: 500000
sendry_rate_limit_default_domain:
  messages_per_hour: 1000
  messages_per_day: 10000
sendry_rate_limit_default_sender:
  messages_per_hour: 100
  messages_per_day: 1000
sendry_rate_limit_default_ip:
  messages_per_hour: 500
  messages_per_day: 5000
sendry_rate_limit_default_api_key:
  messages_per_hour: 1000
  messages_per_day: 10000

# Per-recipient-domain limits (limit emails TO specific mail providers)
# Checked at send time - if exceeded, message is deferred (not rejected)
sendry_rate_limit_default_recipient_domain: {}
#  messages_per_hour: 5000
#  messages_per_day: 50000

# Override limits for specific recipient domains
sendry_rate_limit_recipient_domains: {}
# Example:
#   gmail.com:
#     messages_per_hour: 1000
#     messages_per_day: 10000
#   mail.ru:
#     messages_per_hour: 1000
#     messages_per_day: 10000

# API settings
sendry_api_listen: ":8080"
sendry_api_key: ""  # Required! Set in inventory
sendry_api_max_header_bytes: 1048576
sendry_api_read_timeout: 30s
sendry_api_write_timeout: 30s
sendry_api_idle_timeout: 60s

# IP addresses/CIDRs allowed to access API (empty = allow all)
# Note: /health endpoint is always accessible for load balancer health checks
sendry_api_allowed_ips: []
# Example:
#   - "10.0.0.0/8"
#   - "192.168.1.0/24"
#   - "203.0.113.50"

# Queue settings
sendry_queue_workers: 4
sendry_queue_retry_interval: 5m
sendry_queue_max_retries: 5
sendry_queue_process_interval: 10s

# Storage settings
sendry_storage_path: "{{ sendry_data_dir }}/queue.db"
sendry_storage_retention_delivered_max_age: 168h
sendry_storage_retention_cleanup_interval: 1h

# DLQ settings
sendry_dlq_enabled: true
sendry_dlq_max_age: 720h
sendry_dlq_max_count: 10000
sendry_dlq_cleanup_interval: 1h

# Logging
sendry_log_level: info
sendry_log_format: json

# Header rules
sendry_header_rules_global:
  - action: remove
    headers:
      - X-Originating-IP
      - X-Mailer
      - User-Agent
  - action: add
    header: X-Processed-By
    value: Sendry

sendry_header_rules_domains: {}

# Service management
sendry_service_enabled: true
sendry_service_state: started

# Firewall (UFW) management
sendry_configure_firewall: false
sendry_firewall_allowed_ports:
  - 25
  - 587
  - 465
  - 8080

# =============================================================================
# Sendry Web Panel
# =============================================================================

sendry_web_enabled: false
sendry_web_data_dir: /var/lib/sendry-web
sendry_web_listen: "127.0.0.1:8088"  # localhost only, Caddy will proxy

# Session settings
sendry_web_session_secret: ""  # Required if web enabled! Use ansible-vault
sendry_web_session_ttl: 24h

# Local authentication
sendry_web_local_auth_enabled: true

# OIDC authentication (optional)
sendry_web_oidc_enabled: false
sendry_web_oidc_provider: authentik  # authentik, keycloak, generic
sendry_web_oidc_client_id: ""
sendry_web_oidc_client_secret: ""
sendry_web_oidc_issuer_url: ""
sendry_web_oidc_redirect_url: ""
sendry_web_oidc_scopes:
  - openid
  - profile
  - email
sendry_web_oidc_allowed_groups: []

# MTA servers to connect to
# If empty, will auto-configure to connect to local MTA
sendry_web_servers: []
# Example:
#   - name: "mta-1"
#     base_url: "http://localhost:8080"
#     api_key: "{{ sendry_api_key }}"
#     env: "prod"

# Multi-send strategy
sendry_web_multi_send_strategy: round_robin  # round_robin, weighted_round_robin, domain_affinity
sendry_web_multi_send_weights: {}
sendry_web_multi_send_domain_affinity: {}
sendry_web_multi_send_failover_enabled: true
sendry_web_multi_send_failover_max_retries: 2

# Web service management
sendry_web_service_enabled: true
sendry_web_service_state: started

# =============================================================================
# Caddy Reverse Proxy (for sendry-web HTTPS)
# =============================================================================

sendry_caddy_enabled: false
sendry_caddy_domain: ""  # Required if caddy enabled! e.g., panel.example.com
sendry_caddy_email: ""   # ACME email for Let's Encrypt

# Additional Caddy global options
sendry_caddy_extra_global: ""

# Additional Caddy site options (inside the site block)
sendry_caddy_extra_site: ""

# =============================================================================
# Caddy API Load Balancer (for MTA cluster)
# =============================================================================

sendry_caddy_api_enabled: false
sendry_caddy_api_domain: ""  # e.g., api.example.com

# Backend MTA servers (ip:port or hostname:port)
sendry_caddy_api_backends: []
# Example:
#   - "192.168.1.10:8080"
#   - "192.168.1.11:8080"
#   - "192.168.1.12:8080"

# Load balancing policy: round_robin, least_conn, first, random, ip_hash
sendry_caddy_api_lb_policy: round_robin

# Health check
sendry_caddy_api_health_check: true
sendry_caddy_api_health_uri: /health
sendry_caddy_api_health_interval: 10s

# IP whitelist (empty = allow all)
sendry_caddy_api_allowed_ips: []
# Example:
#   - "10.0.0.0/8"
#   - "192.168.0.0/16"
#   - "203.0.113.50"

# Optional: restrict specific paths only (empty = all paths)
sendry_caddy_api_allowed_paths: []
# Example:
#   - "/api/v1/send"
#   - "/api/v1/templates/*"
