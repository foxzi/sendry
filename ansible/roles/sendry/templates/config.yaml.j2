# Sendry configuration
# Generated by Ansible - DO NOT EDIT MANUALLY

server:
  hostname: "{{ sendry_hostname }}"

smtp:
  listen_addr: "{{ sendry_smtp_listen }}"
  submission_addr: "{{ sendry_smtp_submission }}"
  smtps_addr: "{{ sendry_smtp_smtps }}"
  domain: "{{ sendry_smtp_domain }}"
  max_message_bytes: {{ sendry_smtp_max_message_bytes }}
  max_recipients: {{ sendry_smtp_max_recipients }}
  read_timeout: {{ sendry_smtp_read_timeout }}
  write_timeout: {{ sendry_smtp_write_timeout }}
  auth:
    required: {{ sendry_smtp_auth_required | lower }}
    users:
{% for user, password in sendry_smtp_auth_users.items() %}
      {{ user }}: "{{ password }}"
{% endfor %}
    max_failures: {{ sendry_smtp_auth_max_failures }}
    block_duration: {{ sendry_smtp_auth_block_duration }}
    failure_window: {{ sendry_smtp_auth_failure_window }}
{% if sendry_tls_cert_file and sendry_tls_key_file %}
  tls:
    cert_file: "{{ sendry_tls_cert_file }}"
    key_file: "{{ sendry_tls_key_file }}"
{% elif sendry_acme_enabled %}
  tls:
    acme:
      enabled: true
      email: "{{ sendry_acme_email }}"
      domains:
{% for domain in sendry_acme_domains %}
        - "{{ domain }}"
{% endfor %}
      cache_dir: "{{ sendry_acme_cache_dir }}"
      on_demand: {{ sendry_acme_on_demand | lower }}
{% endif %}

{% if sendry_domains %}
domains:
{% for domain, config in sendry_domains.items() %}
  {{ domain }}:
{% if config.dkim_enabled | default(false) %}
    dkim:
      enabled: true
      selector: "{{ config.dkim_selector | default('mail') }}"
      key_file: "{{ sendry_dkim_dir }}/{{ domain }}.key"
{% endif %}
{% if config.rate_limit is defined %}
    rate_limit:
      messages_per_hour: {{ config.rate_limit.messages_per_hour | default(1000) }}
      messages_per_day: {{ config.rate_limit.messages_per_day | default(10000) }}
      recipients_per_message: {{ config.rate_limit.recipients_per_message | default(100) }}
{% endif %}
    mode: {{ config.mode | default('production') }}
{% if config.redirect_to is defined and config.redirect_to %}
    redirect_to:
{% for addr in config.redirect_to %}
      - "{{ addr }}"
{% endfor %}
{% endif %}
{% if config.bcc_to is defined and config.bcc_to %}
    bcc_to:
{% for addr in config.bcc_to %}
      - "{{ addr }}"
{% endfor %}
{% endif %}

{% endfor %}
{% endif %}

rate_limit:
  enabled: {{ sendry_rate_limit_enabled | lower }}
  global:
    messages_per_hour: {{ sendry_rate_limit_global.messages_per_hour }}
    messages_per_day: {{ sendry_rate_limit_global.messages_per_day }}
  default_domain:
    messages_per_hour: {{ sendry_rate_limit_default_domain.messages_per_hour }}
    messages_per_day: {{ sendry_rate_limit_default_domain.messages_per_day }}
  default_sender:
    messages_per_hour: {{ sendry_rate_limit_default_sender.messages_per_hour }}
    messages_per_day: {{ sendry_rate_limit_default_sender.messages_per_day }}
  default_ip:
    messages_per_hour: {{ sendry_rate_limit_default_ip.messages_per_hour }}
    messages_per_day: {{ sendry_rate_limit_default_ip.messages_per_day }}
  default_api_key:
    messages_per_hour: {{ sendry_rate_limit_default_api_key.messages_per_hour }}
    messages_per_day: {{ sendry_rate_limit_default_api_key.messages_per_day }}
{% if sendry_rate_limit_default_recipient_domain %}
  default_recipient_domain:
    messages_per_hour: {{ sendry_rate_limit_default_recipient_domain.messages_per_hour }}
    messages_per_day: {{ sendry_rate_limit_default_recipient_domain.messages_per_day }}
{% endif %}
{% if sendry_rate_limit_recipient_domains %}
  recipient_domains:
{% for domain, limits in sendry_rate_limit_recipient_domains.items() %}
    {{ domain }}:
      messages_per_hour: {{ limits.messages_per_hour }}
      messages_per_day: {{ limits.messages_per_day }}
{% endfor %}
{% endif %}

api:
  listen_addr: "{{ sendry_api_listen }}"
  api_key: "{{ sendry_api_key }}"
  max_header_bytes: {{ sendry_api_max_header_bytes }}
  read_timeout: {{ sendry_api_read_timeout }}
  write_timeout: {{ sendry_api_write_timeout }}
  idle_timeout: {{ sendry_api_idle_timeout }}

queue:
  workers: {{ sendry_queue_workers }}
  retry_interval: {{ sendry_queue_retry_interval }}
  max_retries: {{ sendry_queue_max_retries }}
  process_interval: {{ sendry_queue_process_interval }}

storage:
  path: "{{ sendry_storage_path }}"
  retention:
    delivered_max_age: {{ sendry_storage_retention_delivered_max_age }}
    cleanup_interval: {{ sendry_storage_retention_cleanup_interval }}

dlq:
  enabled: {{ sendry_dlq_enabled | lower }}
  max_age: {{ sendry_dlq_max_age }}
  max_count: {{ sendry_dlq_max_count }}
  cleanup_interval: {{ sendry_dlq_cleanup_interval }}

logging:
  level: "{{ sendry_log_level }}"
  format: "{{ sendry_log_format }}"

header_rules:
  global:
{% for rule in sendry_header_rules_global %}
    - action: {{ rule.action }}
{% if rule.headers is defined %}
      headers:
{% for header in rule.headers %}
        - "{{ header }}"
{% endfor %}
{% endif %}
{% if rule.header is defined %}
      header: "{{ rule.header }}"
{% endif %}
{% if rule.value is defined %}
      value: "{{ rule.value }}"
{% endif %}
{% endfor %}
{% if sendry_header_rules_domains %}
  domains:
{% for domain, rules in sendry_header_rules_domains.items() %}
    {{ domain }}:
{% for rule in rules %}
      - action: {{ rule.action }}
{% if rule.headers is defined %}
        headers:
{% for header in rule.headers %}
          - "{{ header }}"
{% endfor %}
{% endif %}
{% if rule.header is defined %}
        header: "{{ rule.header }}"
{% endif %}
{% if rule.value is defined %}
        value: "{{ rule.value }}"
{% endif %}
{% endfor %}
{% endfor %}
{% endif %}
