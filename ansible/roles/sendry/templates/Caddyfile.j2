# Caddyfile for Sendry
# Generated by Ansible - DO NOT EDIT MANUALLY
{% if sendry_caddy_extra_global %}

{{ sendry_caddy_extra_global }}
{% endif %}
{% if sendry_caddy_email %}

{
    email {{ sendry_caddy_email }}
}
{% endif %}
{% if sendry_caddy_domain %}

# Sendry Web Panel
{{ sendry_caddy_domain }} {
    reverse_proxy {{ sendry_web_listen }}

    encode gzip

    header {
        # Security headers
        X-Content-Type-Options nosniff
        X-Frame-Options DENY
        Referrer-Policy strict-origin-when-cross-origin
        -Server
    }

    log {
        output file /var/log/caddy/sendry-web.log
        format json
    }
{% if sendry_caddy_extra_site %}

    {{ sendry_caddy_extra_site | indent(4) }}
{% endif %}
}
{% endif %}
{% if sendry_caddy_api_enabled and sendry_caddy_api_backends %}

# Sendry API Load Balancer
{{ sendry_caddy_api_domain }} {
{% if sendry_caddy_api_allowed_ips %}
    @allowed remote_ip {{ sendry_caddy_api_allowed_ips | join(' ') }}

    handle @allowed {
{% if sendry_caddy_api_allowed_paths %}
{% for path in sendry_caddy_api_allowed_paths %}
        handle_path {{ path }} {
            reverse_proxy {{ sendry_caddy_api_backends | join(' ') }} {
                lb_policy {{ sendry_caddy_api_lb_policy }}
{% if sendry_caddy_api_health_check %}
                health_uri {{ sendry_caddy_api_health_uri }}
                health_interval {{ sendry_caddy_api_health_interval }}
{% endif %}
            }
        }
{% endfor %}
        handle {
            respond "Not Found" 404
        }
{% else %}
        reverse_proxy {{ sendry_caddy_api_backends | join(' ') }} {
            lb_policy {{ sendry_caddy_api_lb_policy }}
{% if sendry_caddy_api_health_check %}
            health_uri {{ sendry_caddy_api_health_uri }}
            health_interval {{ sendry_caddy_api_health_interval }}
{% endif %}
        }
{% endif %}
    }

    handle {
        respond "Forbidden" 403
    }
{% else %}
{% if sendry_caddy_api_allowed_paths %}
{% for path in sendry_caddy_api_allowed_paths %}
    handle_path {{ path }} {
        reverse_proxy {{ sendry_caddy_api_backends | join(' ') }} {
            lb_policy {{ sendry_caddy_api_lb_policy }}
{% if sendry_caddy_api_health_check %}
            health_uri {{ sendry_caddy_api_health_uri }}
            health_interval {{ sendry_caddy_api_health_interval }}
{% endif %}
        }
    }
{% endfor %}
    handle {
        respond "Not Found" 404
    }
{% else %}
    reverse_proxy {{ sendry_caddy_api_backends | join(' ') }} {
        lb_policy {{ sendry_caddy_api_lb_policy }}
{% if sendry_caddy_api_health_check %}
        health_uri {{ sendry_caddy_api_health_uri }}
        health_interval {{ sendry_caddy_api_health_interval }}
{% endif %}
    }
{% endif %}
{% endif %}

    encode gzip

    header {
        X-Content-Type-Options nosniff
        -Server
    }

    log {
        output file /var/log/caddy/sendry-api.log
        format json
    }
}
{% endif %}
